# syntax=docker/dockerfile:1.4
# =============================================================================
# OPTIMIZED EV-RETH DOCKERFILE FOR PRODUCTION - NO CARGO-CHEF
# Target: ~2GB â†’ ~80MB (25x reduction)
# Security: Non-root user, distroless base
# Performance: Stripped binary, optimized builds
# =============================================================================

FROM rustlang/rust:nightly-slim AS builder
WORKDIR /app

LABEL org.opencontainers.image.licenses="MIT OR Apache-2.0"
LABEL org.opencontainers.image.source="https://github.com/ande-labs/ev-reth"
LABEL org.opencontainers.image.description="ANDE EV-RETH Execution Client"

# Install only essential build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        pkg-config \
        libssl-dev \
        clang \
        libclang-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy all source code
COPY . .

# Production build configuration
ARG BUILD_PROFILE=release
ENV BUILD_PROFILE=$BUILD_PROFILE

# Optimized build flags for size and performance
ARG RUSTFLAGS="-C codegen-units=1 -C target-cpu=generic -C strip=symbols"
ENV RUSTFLAGS="$RUSTFLAGS"
ENV CARGO_BUILD_JOBS=4
ENV CARGO_INCREMENTAL=0

# Build the binary with all optimizations (legacy builder compatible)
RUN cargo build --profile $BUILD_PROFILE --bin ev-reth --manifest-path bin/ev-reth/Cargo.toml --features jemalloc && \
    strip target/$BUILD_PROFILE/ev-reth && \
    cp target/$BUILD_PROFILE/ev-reth /ev-reth

# Verify binary works and get version info
RUN /ev-reth --version

# =============================================================================
# RUNTIME STAGE: Distroless for minimal attack surface
# =============================================================================
FROM gcr.io/distroless/cc-debian12:nonroot

# Copy only the binary and SSL certificates
COPY --from=builder --chown=nonroot:nonroot /ev-reth /usr/local/bin/ev-reth
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# Create data directory with proper permissions
USER nonroot:nonroot
WORKDIR /data

# Expose production ports
# 30303: P2P networking
# 8545: HTTP JSON-RPC  
# 8546: WebSocket JSON-RPC
# 8551: Engine API (JWT authenticated)
# 9001: Metrics
EXPOSE 30303 30303/udp 8545 8546 8551 9001

# Production-ready health check
HEALTHCHECK --interval=15s --timeout=10s --start-period=60s --retries=3 \
    CMD ["/usr/local/bin/ev-reth", "--version"]

# Default entrypoint and command for production
ENTRYPOINT ["/usr/local/bin/ev-reth"]
CMD ["node", "--datadir", "/data"]

# Final metadata
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.vendor="ANDE Labs"
LABEL org.opencontainers.image.title="EV-RETH"
LABEL org.opencontainers.image.description="Optimized Ethereum execution client for ANDE blockchain"